**confファイルの許容される記述方法と禁止されている記述方法のまとめ**

このwebservでは、NGINXに似た形式のウェブサーバー設定ファイルを使用します。以下に、許容される記述方法と禁止されている記述方法をまとめます。

---

## 全体構造

- **グローバルスコープ**:
  - グローバルレベルでは、`server`ブロックのみが許容されます。
  - 設定ファイルは複数の`server`ブロックを含むことができます。

- **ブロックのネスト**:
  - `server`ブロック内に`location`ブロックを含めることができます。
  - `server`ブロック内に別の`server`ブロックをネストすることは**禁止**されています。
  - `location`ブロックは**必ず**`server`ブロック内に記述する必要があります。
  - `location`ブロック内に別の`location`ブロックをネストすることは**禁止**されています。
  - `location`ブロック内に`server`ブロックをネストすることは**禁止**されています。

- **中括弧 `{}`**:
  - すべての開き中括弧 `{` と閉じ中括弧 `}` は**正しく対応**している必要があります。
  - 開き中括弧 `{` は、`server` または `location` ディレクティブの直後に配置されなければなりません。
  - 開き中括弧 `{` は、`server` または `location`の直後(もしくは引数の直後)に、スペース1つで区切られて配置されます。
  - ```nginx
	server {
		location / {
			# ブロック内の設定
		}
	}
	```

---

## 許容されるディレクティブとその記述方法

### **`server` ブロック内のディレクティブ**

#### 1. `listen`

- **書式**: `listen [IPアドレス:]ポート;`
- **詳細**:
  - **IPアドレス**（省略可能）は、有効なIPv4アドレスでなければなりません。
  - **ポート番号**は `1` から `65535` の間の整数でなければなりません。
  - 同じポート番号の重複指定は**禁止**されています。
  - 複数回指定した場合、追加の挙動になります。

#### 2. `server_name`

- **書式**: `server_name ドメイン名1 [ドメイン名2 ...];`
- **詳細**:
  - ドメイン名は有効な形式で、以下を満たす必要があります：
    - 英数字（`A`〜`Z`、`a`〜`z`、`0`〜`9`）、ハイフン（`-`）、ドット（`.`）のみを使用。
    - ハイフンはラベル（ドットで区切られた部分）の先頭または末尾に使用不可。
    - ラベルは `1`〜`63` 文字以内。
    - 全体のドメイン名は `253` 文字以内。
  - ドメイン名の重複指定は**禁止**されています。
  - 複数回指定した場合、追加の挙動になります。

#### 3. `error_page`

- **書式**: `error_page ステータスコード1 [ステータスコード2 ...] パス;`
- **詳細**:
  - **ステータスコード**は `100` から `599` の間の3桁の整数でなければなりません。
  - **パス**は `/` で始まる絶対パスで、存在するファイルでなければなりません。
  - ステータスコードの重複指定は**禁止**されています。
  - 複数回指定した場合、追加の挙動になります。

#### 4. `client_max_body_size`

- **書式**: `client_max_body_size サイズ;`
- **詳細**:
  - サイズは正の整数で、単位（`k`、`m`、`g`、`K`、`M`、`G`）を付加可能です。
  - 少数や負の数は**禁止**されています。
  - 単位を付加しない場合、バイト数として解釈されます。
  - 複数回指定した場合、**最後の指定が有効**となります。

#### 5. `root`

- **書式**: `root パス;`
- **詳細**:
  - パスは `/` で始まる絶対パスでなければなりません。
  - 存在するディレクトリで、書き込み権限が必要です。
  - 複数回指定した場合、**最後の指定が有効**となります。

#### 6. `index`

- **書式**: `index ファイル名1 [ファイル名2 ...];`
- **詳細**:
  - ファイル名のみを指定し、`/` や `\` を含めることは**禁止**されています。
  - ファイル名は `255` 文字以内で、以下の文字のみ使用可能：
    - 英数字（`A`〜`Z`、`a`〜`z`、`0`〜`9`）
    - ドット（`.`）、ハイフン（`-`）、アンダースコア（`_`）
  - 複数のファイル名を指定可能です。
  - 複数回指定した場合、**最後の指定が有効**となります。

#### 7. `autoindex`

- **書式**: `autoindex on|off;`
- **詳細**:
  - `on` または `off` を指定します（大文字・小文字は区別しません）。
  - 複数回指定した場合、**最後の指定が有効**となります。

#### 8. `location`

- **書式**: `location パス { ... }`
- **詳細**:
  - パスは `/` で始まる必要があります。
  - `location` ブロックは `server` ブロック内にのみ記述可能です。
  - 同一のパスを持つ `location` ブロックの重複定義は**禁止**されています。
  - パスの重複定義は**禁止**されています。
  - 複数回指定した場合、追加の挙動になります。

---

### **`location` ブロック内のディレクティブ**

#### 1. `root`

- **書式**: `root パス;`
- **詳細**:
  - `server` ブロック内の `root` を上書きします。
  - パスの要件は `server` ブロック内の `root` と同様です。
  - 複数回指定した場合、**最後の指定が有効**となります。

#### 2. `methods`

- **書式**: `methods METHOD1 [METHOD2 ...];`
- **詳細**:
  - 許可される HTTP メソッドは `GET`、`POST`、`DELETE` のみです。
  - メソッド名は大文字で指定し、重複は**禁止**されています。
  - 少なくとも1つのメソッドを指定する必要があります。
  - 複数回指定した場合、**最後の指定が有効**となります。

#### 3. `return`

- **書式**: `return ステータスコード [URL];`
- **詳細**:
  - ステータスコードは `100` から `599` の間の3桁の整数です。
  - URL は省略可能で、相対パスまたは絶対 URL を指定できます。
  - 複数回指定した場合、**最後の指定が有効**となります。

#### 4. `autoindex`

- **書式**: `autoindex on|off;`
- **詳細**:
  - `server` ブロック内の `autoindex` を上書きします。
  - 指定方法は `server` ブロック内と同様です。
  - 複数回指定した場合、**最後の指定が有効**となります。

#### 5. `index`

- **書式**: `index ファイル名1 [ファイル名2 ...];`
- **詳細**:
  - `server` ブロック内の `index` を上書きします。
  - 指定方法は `server` ブロック内と同様です。
  - 複数回指定した場合、**最後の指定が有効**となります。

#### 6. `cgi_extension`

- **書式**: `cgi_extension 拡張子 パス;`
- **詳細**:
  - 拡張子は `.cgi`、`.py`、`.sh` のいずれかです。
  - パスは実行可能なファイルへの絶対パスでなければなりません。
  - 拡張子またはパスの重複定義は**禁止**されています。
  - 複数回指定した場合、追加の挙動になります。

#### 7. `upload_enable`

- **書式**: `upload_enable on|off;`
- **詳細**:
  - ファイルアップロード機能を有効または無効にします。
  - 指定方法は `autoindex` と同様です。
  - 複数回指定した場合、**最後の指定が有効**となります。


#### 8. `upload_store`

- **書式**: `upload_store パス;`
- **詳細**:
  - アップロードされたファイルを保存するディレクトリのパスを指定します。
  - パスは `/` で始まる絶対パスで、存在するディレクトリでなければなりません。
  - 書き込み権限が必要です。
  - 複数回指定した場合、**最後の指定が有効**となります。

---

## 禁止されている記述方法と構文

- **未知のディレクティブの使用**:
  - 上記以外のディレクティブは**使用できません**。

- **中括弧の不一致**:
  - 開き中括弧 `{` と閉じ中括弧 `}` が対応していない場合は**エラー**となります。

- **不正な中括弧の配置**:
  - 開き中括弧 `{` は、`server` または `location` ディレクティブの直後にのみ置くことができます。
  - それ以外の場所での `{` の使用は**禁止**されています。

- **`server` ブロックのネスト**:
  - `server` ブロック内に別の `server` ブロックをネストすることは**禁止**されています。

- **必須ディレクティブの欠如**:
  - `server` ブロック内で `listen` または `root` ディレクティブが欠如している場合は**エラー**となります。

- **ディレクティブの引数の不足または過剰**:
  - 指定されたディレクティブごとに、正しい数の引数を提供する必要があります。
  - 例:
    - `client_max_body_size` は **1つの引数**が必要です。
    - `error_page` は **2つ以上の引数**が必要です（ステータスコードとパス）。

- **無効な引数の値**:
  - IPアドレスやポート番号、サイズ、ステータスコードなどの引数は、有効な値でなければなりません。
  - 例:
    - 無効な IP アドレス (`256.256.256.256`) は使用できません。
    - ポート番号は `1` から `65535` の間でなければなりません。

- **重複が禁止されている項目の再定義**:
  - 以下の項目の重複定義は**禁止**されています：
    - `listen` ディレクティブでの同じポート番号
    - `server_name` での同じドメイン名
    - `error_page` での同じステータスコード
    - `location` ブロック内での同じパス
    - `methods` での同じ HTTP メソッド
    - `cgi_extension` での同じ拡張子または実行ファイルパス

- **パスの不正**:
  - 存在しないファイルやディレクトリへのパス指定は**禁止**されています。
  - パスは `/` で始まる絶対パスでなければなりません。
  - 必要な権限（読み取り、書き込み、実行）がないパスは**使用できません**。

- **無効な文字の使用**:
  - ドメイン名、ファイル名、パスなどで許可されていない文字の使用は**禁止**されています。

---

## まとめ

この設定ファイルでは、ディレクティブの種類、配置、引数の数と値、パスの有効性など、さまざまな要件が定義されています。正しい設定ファイルを作成するためには、以下のポイントに注意してください。

1. **ディレクティブの種類と配置**:
   - 許可されたディレクティブのみを使用する。
   - `server` および `location` ブロックのネストと配置を正しく行う。

2. **中括弧の使用**:
   - 開き `{` と閉じ `}` のペアを正しく配置する。
   - `{` は `server` または `location` ディレクティブの直後にのみ置く。

3. **引数の数と値**:
   - 各ディレクティブに対して正しい数の引数を提供する。
   - 引数の値が有効であることを確認する（例：有効なIPアドレス、存在するパスなど）。

4. **重複の回避**:
   - 重複が禁止されている項目を再定義しない。

5. **パスとファイルの有効性**:
   - 指定するパスやファイルが存在し、必要な権限があることを確認する。

これらのガイドラインに従うことで、サーバーが正しく設定され、期待どおりに動作することが保証されます(多分)。設定ファイルの作成や編集時には、これらのルールを念頭に置いてください。
